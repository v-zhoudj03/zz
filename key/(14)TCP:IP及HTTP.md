客户端开发，一般都用AFNetworking或者Alamofire，常用发送HTTP请求的方法无非是post、get、put、delete、head、patch等。那么HTTP是什么？TCP/IP是什么原理？



##### 1、什么是TCP/IP?

- TCP/IP是一类协议系统，它是一套支持网络通信的协议集合。网络是计算机或类似计算机的设备之间通过常用的传输介质进行通信的集合。
- 网络协议就是一套同样规则，用来帮助定义复杂数据传输的过程。数据传输从一台计算机上的应用程序开始，通过计算机网络硬件，经过传输介质到正确的目的地，然后上传到目的地计算机网络硬件，最后到达负责接收的应用程序。

- TCP/IP协议定义了网络通信过程，更重要的是，定义了数据单元的格式和内容，以便接收计算机能够正确解释收到的消息。TCP/IP被称为协议簇。

- TCP/IP标准定义了TCP/IP网络的通信规则；TCP/IP实现是一个软件组件，计算机通过它参与到TCP/IP网络中。

#### 2、TCP/IP的特性

- 逻辑编址：TCP/IP通过逻辑编址提供了子网化的能力。逻辑地址是一个通过网络软件来配置的地址。在TCP/IP中，计算机的逻辑地址被称为IP地址。
- 路由选择：路由器是一种特殊的设备，能够读取逻辑地址信息，并将数据通过网络直接传送到它的目的地。在局域网中，数据传输到另一台计算机或设备时，不用经过路由器，因此不会给大型网络的传输带来负担。如果数据要传送到子网以外的计算机上，路由器将负责转发数据。
- 名称解析：域名到IP地址的映射称为名称解析。域名服务器的专用计算机中存储了用于显示域名和IP地址转换方式的表。

- 错误控制和流程控制：TCP/IP协议簇提供了确保数据在网络中可靠传送的特性。这些特性包括检查数据的传输错误（确保到达的数据与发送的数据一致）和确认成功接收到网络信息。
- 应用支持：同一台计算机可以运行多种网络应用程序。协议软件必须提供某些方法来判断接收到的数据包属于哪个应用程序。在TCP/IP中，这个通过系统的逻辑通道实现从网络到应用程序的接口被称为端口。

#### 3、TCP/IP的工作方式

##### TCP/IP协议系统

- TCP/IP协议系统必须要完成的任务：
  - 把消息分解为可管理的数据块，并且这些数据块能够有效地通过传输介质
  - 与网络适配器硬件连接
  - 寻址，即发送端计算机必须能够定位到接收数据的计算机，接收计算机能够识别自己要接收的数据
  - 将数据路由到目的计算机所在的子网，即使源子网和目的子网分处不同的物理网络
  - 执行错误控制、流量控制和确认：对可靠的通信而言，发送和接收计算机必须能够发现并纠正传输错误，并控制数据流
  - 从应用程序接收数据并传输到网络
  - 从网络接收数据并传输到应用程序
- TCP/IP模型的协议层：应用层->传输层->网际层->网络访问层（数据链路层-物理层）
  - 网络访问层：提供了与物理网络连接的接口。针对传输介质设置数据的格式，根据硬件的物理地址实现数据的寻址，对数据在物理网络中的传递提供错误控制
  - 网际层：提供独立于硬件的逻辑地址，从而让数据能够在具有不同物理结构的子网之间传递。提供路由功能来降低流量，支持网间的数据传递。实现物理地址与逻辑地址的转换。
  - 传输层：为网络提供了流量控制、错误控制和确认服务。充当网络应用程序的接口
  - 应用层：为网络排错、文件传输、远程控制和Internet操作提供了应用程序。

#### 4、TCP/IP与OSI模型

- OSI模型：
  - 物理层：把数据转换为传输介质上的电子流或模拟脉冲，并且监视数据的传输
  - 数据链路层：提供与网络适配器相连的接口，维护子网的逻辑链接
  - 网络层：支持逻辑寻址与路由选择
  - 传输层：为网络提供错误控制与数据控制
  - 会话层：在计算机的通信应用程序之间建立会话
  - 表示层：把数据转换为标准格式，管理数据加密与压缩
  - 应用层：为应用程序提供网络接口，支持文件传输、通信等功能的网络应用



#### 网际协议

1、IP协议提供了一种分层的、与硬件无关的寻址系统，具有在复杂的路由式网络中传递数据所需的服务。TCP/IP网络上的每个网络适配器都有一个唯一的IP地址

2、IP地址分为两个部分，网络ID和主机ID。网络必须提供一种方式来判断IP地址的哪一部分是网络ID，哪一部分是主机ID



IP报头字段：

![IP报头](/System/Volumes/Data/Users/zhoudengjie/文档/zz/pics/IPDataHeader.jpg)

1、每个IP数据报都以一个IP报头开始。源计算机的TCP/IP软件构造这个IP报头，目的计算机的TCP/IP软件利用IP报头中封装的信息处理数据。IP报头包含大量信息，包括源IP地址、目的IP地址、数据报长度、IP版本号和路由的特殊指令

2、IP数据报由报头和数据两部分组成。报头由一个20字节的固定长度和一个可选任意长度部分组成。IP数据报最长为65535字节



- 版本：IP版本，目前IP版本是4，二进制是0100
- 网际报头长度（IHL）：表示IP报头以32位字节为单位的长度，IP报头的最小长度是5个32比特字，二进制是0101
- 服务类型：源IP能够制定特殊的路由信息。
- 总长度：IP数据报的总长度，单位是字节，包含IP报头和数据载荷
- 标识：这个16位的字段是一个依序变大的数值，分配给源IP发出的消息。当传递到IP层的消息太大而不能放到一个数据报时，IP会把消息分拆到多个数据报，并对这些数据报排序分配相同的标识号。接收端利用这个数值重组为原始消息
- 标记：表示分段可能性。第1位未使用，其值应该为0.第2位称为DF（不分段），表示是否允许分段，0表示允许，1表示不允许第3位是MF（更多分段），表示是否还有分段正在传输，设置为0时表示没有，或者数据报根本没有分段
- 分段位移：这个为13位的字段是一个数值，被赋予每个连续的分段。目的设备的IP利用这个值以正确的次序重组分段，这个数值使用的单位是8字节
- 生存时间（TTL）：这个字段表示数据报在被抛弃之前能够保留的时间（以秒为单位）或路由器跳数。每个路由器都会检查这个字段，并且至少把它减去1，或数据报在路由器中延迟的秒数，当这个字段的值为0时，数据报会被抛弃
- 跳数表示数据报到达目的之前必须经过的路由器的数量。
- 协议：这个8位的字段表示接收数据载荷的协议，1：ICMP，6：TCP，17：UDP
- 报头校验和：这个字段包含16位的检验和，只用于检验报头本身的有效性。数据报经过的每个路由器都会对这个值进行重新计算，因为TTL字段的值是在不断变化的。
- 源IP地址：这个32位的字段包含了数据报的源IP地址
- 目的IP地址：这个32位的字段包含了数据报的目的IP地址，目的IP根据这个值检验发送的正确性
- IP选项：这个字段支持一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由（数据报必须经过指定的路由）、网络时间戳（经过每个路由器时的时间戳记录）和安全限制
- 填充：IP选项字段的长度不是固定的，填充字段可以提供一些额外的0，从而保证整个报头的长度是32位的整数倍（报头长度必须是32位的整数倍，因为网际头长度（IHL）字段以32位字节为单位表示报头的长度）
- IP数据载荷：这个字段一般用于保存传递给TCP或UDP（在传输层中）、ICMP或IGMP的数据。数据块的长度不定，可以包含数千字节。

#### 传输层：

- 传输控制协议TCP：TCP提供了完善的错误控制和流量控制，能够确保数据正确传输，它是一个面向连接的协议
- 用户数据报协议UDP：UDP只提供了非常基本的错误检测，用于不需要TCP精细控制功能的场合，它是一个无连接的协议



**面向连接协议：**会在通信计算机之间建立并维护一个连接，并且在通信过程中监视连接状态。通过网络传输的每个数据包都会有一个确认，发送端计算机会记录状态信息来确保每个数据包都被正确无误地接收了，并且在需要时会重发数据。当数据传输结束后，发送端和接收端计算机会以适当的方式关闭连接。

**无连接协议：**以单向方式向目的计算机发送数据报，不承担通知目的计算机关于数据发送的职责。目的计算机接收到数据后也不需要向源计算机返回状态信息



**端口和套接字**

- 在TCP/IP系统中，应用程序可以使用端口号通过TCP或UDP指定数据目的地。端口是一个预定义的内部地址，充当从应用程序到传输层或是从传输层到应用程序的通路
- TCP或UDP数据实际是被发送到一个套接字上的。套接字是一个由IP地址和端口号组成的地址。





#####1、TCP重要特性

- 面向流的处理：TCP以流的方式处理数据。TCP可以一个字节一个字节地接收数据，而不是依次接收一个预定义格式的数据块，TCP把接收到的数据组成长度不定的段，再传递到网际层
- 重新排序：如果数据以错误的顺序到达目的地，TCP模块能够对数据重新排序来恢复原始顺序
- 流量控制：TCP的流量控制特性能够确保数据传输不会超过目的计算机接收数据的能力。由于现实世界里会有各种不同的应用环境，处理器速度和缓存区大小的差别也可能很大，所以这种流控能力是非常重要的
- 优先级与安全：
- 适当的关闭：TCP像重视连接一样重视关闭连接的工作，以确保连接被关闭之前，使用的数据段都被发送和接收了



#####2、TCP数据格式：

![tcp数据格式](/System/Volumes/Data/Users/zhoudengjie/文档/zz/pics/TCP.jpg)



##### 3、TCP连接

##### 4、建立连接

三次握手总是发生在TCP连接建立的初期。需要三次握手的原因：TCP的三次握手最主要是防止已过期的连接再次传到被连接的主机。

##### 5、TCP流量控制（滑动窗口方法）

接收端计算机利用”窗口“字段（也被称为缓存大小字段）来定义一个超过最后一个已确认序列化的序列号窗口，在这个范围内的序列号才允许发送端计算机进行发送。发送端计算机在没有接收到下一个消息之前不能发送超过这个窗口的序列号

#####6、关闭连接

计算机A发送一个数据分段，其中的FIN标记设置为1。之后应用程序进入fin-wait状态。在这个状态下，计算机的TCP软件继续接受数据分段，并处理已经在序列中的数据分段，但不再从应用程序接收数据了。当计算机B接收到FIN数据分段时，它返回FIN确认信息，然后发送剩余的数据分段，通知本地应用程序接收到FIN消息。计算机B向计算机A发送一个FIN数据分段，计算机A返回确认信息，连接就被关闭了。

##### 7、TCP如何保证可靠性

TCP的可靠性是通过顺序编号和确认ACK来实现的。TCP在开始传送一个段时，为准备重传而先将该段插入到发送队列中，同时启动时钟。其后，如果收到了接收端对该段的ACK信息，就将该段从队列中删去。如果在时钟规定的时间内，ACK未返回，那么就从发送队列中再次送出这个段。TCP在协议中就对数据可靠传输做了保障，握手与断开都需要通讯双方确认，数据传输也需要双方确认成功，在协议中还规定了：分包、重组、重传等规则



#### UDP：无连接传输协议

1、UDP实际上能够执行基本的错误检验，因此，可以说UDP具有有限的错误检验功能。UDP数据报中包含一个校验和，接收端计算机可以利用它来检验数据的完整性

2、UDP的开销没有TCP大

3、UDP不会重新传输丢失或损坏的数据报、重新排列混乱的接受数据、消除重复的数据报、确认数据报的接收、建立或者是终止连接。它主要是在程序不需要使用TCP连接开销的情况下发送和接收数据报的一种方式



#### HTTP

1、超文本传输协议（Hyper Text Transfer Protocol）,工作在OSI参考模型的应用层，是一个基于请求与相应模式的无状态协议，同时也是基于TCP/IP协议来传输数据。

2、主要特点：

- 主要支持B/S模式：平常我们使用的浏览器可根据url向服务器发送请求，服务器拿到HTTP报文之后解析并作出回应，将数据传输回浏览器，TCP三次握手建立连接之后传输数据就是HTTP报文与其他服务器资源
- 简单快速：客户端向服务器请求服务时，只需要传输请求方法（如post、get、put等）和路径（URL资源定位符URI），服务器收到就会将对应的资源和响应返回给客户端
- 灵活：HTTP允许传输任意数据对象，正在传输的类型由`Content-Type`加以标记
- 无连接：每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。但是在HTTP1.1版本之后，在HTTP1.1中已默认使用Connection:keep-alive，避免连接建立和释放的开销，但服务器必须按照客户端请求的先后顺序依次回送响应的结果，以保证客户端能够区分每次请求的响应内容。通过Content-Length字段来判断当前请求的数据是否已经全部接收。不允许同时存在两个并行的响应。但是无连接永远是HTTP的特性，至于下层的TCP连接是否关闭已经不在HTTP管辖范围内，所以HTTP协议还是无连接的。
- 无状态：HTTP协议是无状态协议，无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。



3、HTTP请求响应步骤

- 客户端（通常是浏览器）连接到web服务器（一般默认端口号是80），这时候建立一个套接字连接
- 发送HTTP请求，通过套接字，客户端就可以向web服务器发送一个请求报文
- 服务器接收请求并返回HTTP响应，也就是web服务器解析请求定位请求资源，而后服务器再将资源副本写到TCP套接字由客户端读取
- 如果连接模式为close，那么服务器会主动关闭连接，而客户端是被动关闭连接，如果连接模式为keep-alive，那么连接就会保持一段时间
- 最后就是浏览器解析HTML内容，首先会检查状态行看是否成功，然后解析每一个响应头，最后就是解析前端HTML代码。浏览器会根据状态码来查看是否要接着解析，如出现404，浏览器就会展示异常，这时它是拿不到响应正文的。



#### HTTPS

1、简介：即HTTP+SSL/TLS，即在HTTP上又加了一层处理加密信息的模块。服务端和客户端的信息传输都会通过TLS进行加密，所以传输的数据都是加密后的数据。

SSL：安全套接字层（Secure Socket Layer），是基于HTTPS下的一个协议加密层，位于TCP/IP协议与各种应用层之间，为数据通讯提供安全支持。分为两层：

- SSL记录协议：建立在可靠的传输协议如TCP之上，为高层协议提供数据封装、压缩、加密等基本功能的支持
- SSL握手协议：建立在SSL记录协议之上，用于在实际的数据传输开始前，通信双方进行身份认证、协商加密算法、交换加密密钥等

TLS：安全传输层协议（Transport Layer Security)，用于在两个通信应用程序直接提供保密性和数据完整性，由两层组成：TLS记录协议和TLS握手协议。



HTTPS整个过程如下：

![https](/System/Volumes/Data/Users/zhoudengjie/文档/zz/pics/HTTPS.png)

- 1、客户端发起HTTPS请求

  在浏览器里输入https地址，连接到server的443端口

- 2、服务端的配置

  服务器必须要有一套数字证书，可以自己制作，也可以向组织（CA）申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。这套证书就是一对公钥私钥。

- 3、传送证书

  即公钥，包含了证书的颁发机构、过期时间等

- 4、客户端解析证书

  由客户端的TLS来完成，首先会验证公钥是否有效，比如颁发机构、过期时间等，如果发现异常，则提示证书有问题。如果没有问题，就生成一个随机值，然后用证书对该随机值进行加密。

- 5、传送加密信息

  传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值进行加密解密了

- 6、服务端解密信息

  服务端用私钥解密后，得到客户端传过来的随机值（私钥）然后把内容通过该值进行对称加密。

- 7、传输加密后的信息

  服务端用私钥加密后的信息，可以被客户端还原

- 8、客户端解密信息

  客户端用之前生成的私钥解密服务端传过来的信息，获取解密后的内容。



#### SSL

1、特性：

- 保密：在握手协议中定了会话密钥后，所有的消息都被加密
- 鉴别：可选的客户端认证，和强制的服务端认证
- 完整性：传送的消息包括消息完整性检查（使用MAC）

2、SSL位置

​	介于应用层和TCP层之间。应用层数据不再直接传递给传输层，而是传递给SSL层，SSL层对从应用层收到的数据进行加密，并增加自己的SSL头

3、工作原理

- 握手协议

  握手协议是客户机和服务器用SSL连接通信时使用的第一个子协议，握手协议包括客户机与服务器之间的一系列消息。SSL中最复杂的就是握手协议。该协议允许服务器和客户机相互验证，协商加密和MAC算法及保密密钥，用来保护在SSL记录中发送的数据。握手协议是在应用程序的数据传输之前使用的。握手协议4个阶段：

  - 建立安全能力
  - 服务器鉴别与密钥交换
  - 客户机鉴别与密钥交换
  - 完成

  

- 记录协议

  记录协议在客户机和服务器握手成功后使用，即客户机和服务器鉴别对方和确定安全信息交换使用的算法后，进入SSL记录协议，记录协议向SSL提供两个服务：

  - 保密性
  - 完整性

- 警报协议

  客户机和服务器发现错误时，向对方发送一个警报消息。如果是致命错误，则算法立即关闭SSL连接，双方还会先删除相关的会话号，秘密和密钥。每个警报消息共2个字节，第1个字节表示错误类型，如果是警报，则值为1，如果是致命错误，则值为2；第2个字节制定实际错误类型。



#### RESTful接口

客户端开发时，后台提供的接口一般都要求是RESTful的API，那么什么是RESTful?

> RESTFUL是一种网络应用程序的设计风格和开发方式，基于[HTTP](https://baike.baidu.com/item/HTTP/243074)，可以使用[XML](https://baike.baidu.com/item/XML/86251)格式定义或[JSON](https://baike.baidu.com/item/JSON/2462549)格式定义。RESTFUL适用于移动互联网厂商作为业务使能接口的场景，实现第三方[OTT](https://baike.baidu.com/item/OTT/9960940)调用移动网络资源的功能，动作类型为新增、变更、删除所调用资源。

特点：

- 每一个URI代表1种资源
- 客户端使用get、post、put、delete4个操作方式的动词对服务端的资源进行操作
  - get用来获取资源
  - post用来新建资源（也可以用来更新资源）
  - put用来更新资源
  - delete用来删除资源
- 通过操作资源的表现形式来操作资源
- 资源的表现形式是XML或者HTML
- 客户端与服务端直接的交互在请求之间是无状态的，从客户端到服务端的每个请求都必须包含理解请求所必需的信息



#### DNS(Domain Name System)

DNS名称解析，

\1.     DNS会将名称解析数据防止在一个或多个专用服务器上，由DNS服务器为网络提供名称解析服务。如果网络上计算机需要将某个主机名解析成IP地址，会向服务器发送一个查询，询问与这个地址关联的主机名。如果DNS服务器保存了相应的地址，就将这个地址返回给发出请求的计算机。接下来，这台计算机会用IP地址来替代主机名，进而再执行命令。

\2.     DNS服务器又多个有点，它为本地网络提供了一个单一的DNS配置点，使得网络资源的利用更加有效。然而，DNS无法高效地保存Internet上所有主机名的数据库。解决办法是，使所有名称服务器都可以彼此通信。

\3.     如果DNS在自己保存的地址数据库中发现了被请求的地址，则将这个地址发回给客户端。如果名称服务器在自己保存的记录中没有找到这个地址，会要求其他的名称服务器查找这个地址，接着将这个地址发回给客户端。

4. 工作原理：

当DNS客户机需要在程序中使用名称时，它会查询DNS服务器来解析该名称。客户机发送的每条查询信息包括三条信息：指定的DNS域名，指定的查询类型，DNS域名的指定类别。基于UDP服务，端口53. 该应用一般不直接为用户使用，而是为其他应用服务，如HTTP，SMTP等在其中需要完成主机名到IP地址的转换。

浏览器输入网址之后的过程                                

\1.     应用层：客户端浏览器通过DNS解析到www.baidu.com的IP地址220.181.27.48，通过这个IP地址找到客户端到服务器的路径。客户端浏览器发起一个HTTP会话到220.161.27.48，然后通过TCP进行封装数据包，输入到网络层。

DNS解析IP地址

HTTP访问服务器

\2.     传输层:在客户端的传输层，把HTTP会话请求分成报文段，添加源和目的端口，如服务器使用80端口监听客户端的请求，客户端由系统随机选择一个端口如5000，与服务器进行交换，服务器把相应的请求返回给客户端的5000端口。然后使用IP层的IP地址查找目的端。

\3.     客户端的网络层不用关心应用层或者传输层的东西，主要做的是通过查找路由表确定如何到达服务器，期间可能经过多个路由器，这些都是由路由器来完成的工作，通过查找路由表决定通过那个路径到达服务器,其中用到路由选择协议。

\4.     客户端的链路层，包通过链路层发送到路由器，通过邻居协议查找给定IP地址的MAC地址，然后发送ARP请求查找目的地址，如果得到回应后就可以使用ARP的请求应答交换的IP数据包现在就可以传输了，然后发送IP数据包到达服务器的地址。不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。



DNS劫持：

> DNS劫持又称域名劫持,是指通过某些手段取得某域名的解析控制权，修改此域名的解析结果，导致对该域名的访问由原IP地址转入到修改后的指定IP，其结果就是对特定的网址不能访问或访问的是假网址。







参考：

1、[计算机网络基础知识汇总](https://www.jianshu.com/p/fdeba55e9093)

2、[HTTP协议](https://www.cnblogs.com/Cubemen/p/10831024.html)

3、[图解HTTPS](https://kb.cnblogs.com/page/155287/)

4、[SSL协议详解](http://kb.cnblogs.com/page/162080/)

5、[HTTPS、SSL、TLS三者之间的联系和区别](https://blog.csdn.net/enweitech/article/details/81781405)

6、[RESTful](https://baike.baidu.com/item/RESTful/4406165?fr=aladdin)

